data_config:
  sink:
    type: "json"
    file_path: "tasks/examples/glaive_code_assistant/feedback_outputs/output.json"
    encoding: "utf-8"

graph_config:
  nodes:
    load_schema:
      node_type: lambda
      lambda: tasks.examples.glaive_code_assistant.task_executor_feedback.LoadSchema
      file_path: "c:/Users/fds46198/OneDrive - FactSet/Desktop/SyGra Synthetic/tabledemo.csv"

    prepare_generation_input:
      node_type: lambda
      lambda: tasks.examples.glaive_code_assistant.task_executor_feedback.PrepareGenerationInput

    generate_table:
      node_type: llm
      output_keys:
        - synthetic_table_csv
      post_process: tasks.examples.glaive_code_assistant.task_executor_feedback.SyntheticTablePostProcessor
      prompt:
        - system: |
            You are a financial expert generating synthetic versions of financial statement tables.

            You receive the full CSV of a 10-K/10-Q style table as input and must output a modified CSV.
            Treat each call independently: you generate exactly ONE synthetic table for the given input CSV.

            Apply ALL of the following rules simultaneously:

            SYNTHETICITY / PRIVACY GOAL:
            - The synthetic table must NOT expose the original numbers. Avoid copying exact numeric values from the input.
            - Aim for a strongly synthetic result: most numeric cells should change materially (target ~70-75% of numeric cells changed).
            - Keep the table financially plausible and internally coherent (totals/subtotals/derived relationships).

            ROWS (about 30% change through additions/deletions):
            - Compared with the original table, approximately 30% of the row positions must change.
            - You may DELETE some existing data rows.
            - You may INSERT new data rows with realistic new metrics that did not exist before.
            - The overall number of rows in the synthetic table should differ from the original by roughly 30% (a small deviation is acceptable if needed to keep the table coherent).
            - Header rows, section labels, and subtotal/total rows may be kept, adjusted, or recomputed as needed to stay logically consistent.

            COLUMNS (about 30% new columns, only additions, no deletions):
            - Keep all existing columns and their headers; DO NOT delete any original columns.
            - Add new non-empty data columns on the RIGHT side of the table so that the total number of columns increases by roughly 30% (a small deviation is acceptable).
            - Each new column must have a clear, realistic header (for example a new fiscal year, a new scenario, or a new segment).
            - Fill every cell in each new column with realistic numeric values that are coherent with the rest of the row.

            VALUES AND NUMERICAL COHERENCE:
            - Ensure that totals, subtotals, ratios, and percentage rows remain arithmetically and financially coherent after you add/delete rows and add columns.
            - If you delete a row that previously contributed to a total or subtotal, you MUST adjust the corresponding total/subtotal rows so that they reflect the new components.
            - If you split or merge rows, or add new rows that are part of a total, make sure the totals still equal the sum of their component rows within a reasonable rounding tolerance.
            - When you change numeric values (due to added/deleted rows or added columns), keep the magnitudes, signs, and relationships realistic for financial statements.

            EXAMPLE OF COHERENCE WHEN DELETING A ROW:
            - Suppose originally there are rows A, B, and a TOTAL row T where T = A + B.
            - If you delete row B in the synthetic table, you must change TOTAL T so that it now matches just the remaining rows (for example T_new ~ A_new, and T_new < T_original if B was positive).

            GENERAL RULES:
            - The synthetic table MUST NOT be identical to the input table.
            - Preserve valid CSV formatting (commas, quotes, header row(s)).
            - Do not add any explanations, comments, or JSON; return ONLY the CSV text of the new synthetic table.
        - user: |
            Attempt: {attempt} of {max_attempts}

            Original CSV table:

            {generation_input_csv}

            Prior feedback (accumulated summary of issues to fix; do not regress on already-fixed items):
            {prior_judge_reasoning}

            Produce exactly one synthetic version of this table according to the rules above.
            - Approximately 30% of the row positions must be changed through row additions and/or deletions.
            - The total number of columns should increase by roughly 30% via ADDING new columns on the right; do not delete existing columns.
            - Ensure the result is strongly synthetic: avoid copying exact numeric values from the original; most numeric cells should change materially (target ~70-75%).
            - Ensure that all totals, subtotals, and other derived values remain coherent after your modifications.
            - Return only CSV text; do not repeat the instructions.
      model:
        name: sonnet-4-5
        parameters:
          temperature: 0.2

    llm_judge:
      node_type: llm
      output_keys:
        - judge_reasoning
      post_process: tasks.examples.glaive_code_assistant.task_executor_feedback.JudgeReasoningPostProcessor
      prompt:
        - system: |
            You are a strict auditor for synthetic financial CSV tables.

            You receive:
            - The original input CSV
            - A candidate synthetic CSV

            Your job is to critique the candidate against the explicit constraints below and decide if more feedback is needed.

            CONSTRAINTS TO EVALUATE:
            - The candidate must be valid CSV (consistent column counts per row; no malformed entries).
            - ROWS: It is allowed and expected that approximately ~30% of row positions change via additions/deletions.
            - COLUMNS: The candidate must keep all original columns and may add new non-empty columns on the right (target roughly +30% columns). Do not delete original columns.
            - SYNTHETICITY / PRIVACY: Avoid copying original numeric values; most numeric cells should change materially (target ~70-75%).
            - COHERENCE: Totals/subtotals/derived rows should remain arithmetically and financially coherent after changes.

            If the candidate satisfies ALL constraints, respond with exactly:
            NO MORE FEEDBACK

            Otherwise:
            - Explain clearly what is wrong.
            - Give ONE consolidated instruction to fix it in the next attempt.

            Do not output JSON. Do not output CSV. Output only your critique text.
        - user: |
            Attempt: {attempt} of {max_attempts}

            Original CSV:
            {original_csv}

            Candidate synthetic CSV:
            {synthetic_table_csv}

            Provide critique now.
      model:
        name: sonnet-4-5
        parameters:
          temperature: 0.2

    write_output:
      node_type: lambda
      lambda: tasks.examples.glaive_code_assistant.task_executor_feedback.WriteAttemptOutput
      output_subdir: "feedback_outputs"

    write_reasoning:
      node_type: lambda
      lambda: tasks.examples.glaive_code_assistant.task_executor_feedback.WriteAttemptReasoning
      output_subdir: "feedback_outputs"

    increment_attempt:
      node_type: lambda
      lambda: tasks.examples.glaive_code_assistant.task_executor_feedback.IncrementAttempt

  edges:
    - from: START
      to: load_schema
    - from: load_schema
      to: prepare_generation_input
    - from: prepare_generation_input
      to: generate_table
    - from: generate_table
      to: llm_judge
    - from: llm_judge
      to: write_output
    - from: write_output
      to: write_reasoning
    - from: write_reasoning
      condition: tasks.examples.glaive_code_assistant.task_executor_feedback.ShouldContinueFeedbackCondition
      path_map:
        END: END
        increment_attempt: increment_attempt
    - from: increment_attempt
      to: prepare_generation_input

output_config:
  dummy: true
